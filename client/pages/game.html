<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuBlocks - –ò–≥—Ä–∞</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body style="margin: 0; padding: 0; overflow: hidden;">
    
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</div>
    </div>

    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="game-container" id="game-main" style="display: none;">
        <div class="game-header">
            <div class="user-info">
                <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
                <span>üë§ <strong id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</strong></span>
                <span>‚≠ê –£—Ä. <strong id="level">1</strong></span>
                <span>üèÜ –†–µ–∫–æ—Ä–¥: <strong id="high-score">0</strong></span>
                <span>üí∞ –ú–æ–Ω–µ—Ç—ã: <strong id="coins">0</strong></span>
                <span>üìä –°—á—ë—Ç: <strong id="current-score">0</strong></span>
            </div>
            <button class="btn-logout" onclick="handleLogout()">–í—ã—Ö–æ–¥</button>
        </div>

        <canvas id="game-canvas"></canvas>

        <div id="game-info">
            <p>üéÆ –ù–∞–∂–º–∏—Ç–µ <strong>–ü–†–û–ë–ï–õ</strong> —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –æ—á–∫–∏</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // ==========================================
        // –í–°–¢–†–û–ï–ù–ù–´–ô –ö–û–î –ò–ì–†–´
        // ==========================================

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA76Du2jnVguJavcO7k6XFEQJ0tPhHF_UI",
            authDomain: "rublocks-2862b.firebaseapp.com",
            projectId: "rublocks-2862b",
            storageBucket: "rublocks-2862b.firebasestorage.app",
            messagingSenderId: "1035853997972",
            appId: "1:1035853997972:web:77cf13e7197b9387cd9181"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        console.log('‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

        // ==========================================
        // –ò–ì–†–ê
        // ==========================================
        
        let game = {
            canvas: null,
            ctx: null,
            user: null,
            score: 0,
            coins: 0,
            startTime: Date.now(),

            init: function(user) {
                this.user = user;
                this.canvas = document.getElementById('game-canvas');
                this.ctx = this.canvas.getContext('2d');

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight - 70;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                document.getElementById('username').textContent = user.displayName || user.email.split('@')[0];
                document.getElementById('user-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.uid}`;

                // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                this.loadStats();

                // –°–∫—Ä—ã—Ç–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('game-main').style.display = 'flex';

                // –ó–∞–ø—É—Å–∫
                this.draw();
                this.bindEvents();

                console.log('‚úÖ –ò–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞');
            },

            loadStats: async function() {
                try {
                    const doc = await db.collection('users').doc(this.user.uid).get();
                    if (doc.exists) {
                        const stats = doc.data().stats || {};
                        document.getElementById('level').textContent = stats.level || 1;
                        document.getElementById('high-score').textContent = stats.highScore || 0;
                        document.getElementById('coins').textContent = stats.coins || 0;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                }
            },

            draw: function() {
                // –§–æ–Ω
                this.ctx.fillStyle = '#87CEEB';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // –ó–µ–º–ª—è
                this.ctx.fillStyle = '#90EE90';
                this.ctx.fillRect(0, this.canvas.height - 50, this.canvas.width, 50);

                // –¢–µ–∫—Å—Ç
                this.ctx.fillStyle = '#000';
                this.ctx.font = 'bold 48px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('üéÆ RuBlocks', this.canvas.width / 2, 100);

                this.ctx.font = '28px Arial';
                this.ctx.fillText(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${this.user.displayName || '–ò–≥—Ä–æ–∫'}!`, 
                                 this.canvas.width / 2, 160);

                this.ctx.font = '20px Arial';
                this.ctx.fillStyle = '#666';
                this.ctx.fillText('–ù–∞–∂–º–∏—Ç–µ –ü–†–û–ë–ï–õ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –æ—á–∫–∏', 
                                 this.canvas.width / 2, 220);

                if (this.score > 0) {
                    this.ctx.font = 'bold 36px Arial';
                    this.ctx.fillStyle = '#667eea';
                    this.ctx.fillText(`–°—á—ë—Ç: ${this.score}`, this.canvas.width / 2, 300);
                }
            },

            bindEvents: function() {
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        this.addScore(10);
                        this.addCoins(1);
                    }
                });

                window.addEventListener('resize', () => {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight - 70;
                    this.draw();
                });
            },

            addScore: function(points) {
                this.score += points;
                document.getElementById('current-score').textContent = this.score;

                const highScore = parseInt(document.getElementById('high-score').textContent);
                if (this.score > highScore) {
                    document.getElementById('high-score').textContent = this.score;
                }

                this.draw();
            },

            addCoins: function(amount) {
                this.coins += amount;
                const current = parseInt(document.getElementById('coins').textContent);
                document.getElementById('coins').textContent = current + amount;
            },

            saveStats: async function() {
                try {
                    const playTime = Math.floor((Date.now() - this.startTime) / 1000);
                    
                    const userRef = db.collection('users').doc(this.user.uid);
                    const doc = await userRef.get();
                    
                    if (doc.exists) {
                        const currentStats = doc.data().stats || {};
                        
                        await userRef.update({
                            'stats.gamesPlayed': (currentStats.gamesPlayed || 0) + 1,
                            'stats.highScore': Math.max(currentStats.highScore || 0, this.score),
                            'stats.coins': (currentStats.coins || 0) + this.coins,
                            'stats.totalPlayTime': (currentStats.totalPlayTime || 0) + playTime
                        });
                        
                        console.log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                }
            }
        };

        // ==========================================
        // –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –ó–ê–ü–£–°–ö
        // ==========================================
        
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user.email);
                game.init(user);
            } else {
                console.log('‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
                window.location.href = '../index.html';
            }
        });

        // ==========================================
        // –í–´–•–û–î
        // ==========================================
        
        async function handleLogout() {
            if (confirm('–í—ã–π—Ç–∏? –ü—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω.')) {
                await game.saveStats();
                await auth.signOut();
            }
        }

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            game.saveStats();
        });

        console.log('‚úÖ –°–∫—Ä–∏–ø—Ç—ã –∏–≥—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    </script>
</body>
</html>