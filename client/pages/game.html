<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuBlocks - –ò–≥—Ä–∞</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #current-score,
        #coins,
        #level {
            transition: transform 0.2s;
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</div>
        <p style="color: #999; margin-top: 20px; font-size: 14px;">
            –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...
        </p>
    </div>

    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã -->
    <div class="game-container" id="game-main" style="display: none;">
        <!-- –®–∞–ø–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∏–≥—Ä–æ–∫–µ -->
        <div class="game-header">
            <div class="user-info">
                <img id="user-avatar" class="user-avatar" src="https://via.placeholder.com/45" alt="Avatar">
                <span>üë§ <strong id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</strong></span>
                <span>‚≠ê –£—Ä. <strong id="level">1</strong></span>
                <span>üèÜ –†–µ–∫–æ—Ä–¥: <strong id="high-score">0</strong></span>
                <span>üí∞ –ú–æ–Ω–µ—Ç—ã: <strong id="coins">0</strong></span>
                <span>üìä –°—á—ë—Ç: <strong id="current-score">0</strong></span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn-logout" onclick="handleLogout()">–í—ã—Ö–æ–¥</button>
            </div>
        </div>

        <!-- –ò–≥—Ä–æ–≤–æ–π —Ö–æ–ª—Å—Ç -->
        <canvas id="game-canvas"></canvas>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
        <div id="game-info">
            <p>üéÆ –ù–∞–∂–º–∏—Ç–µ <strong>–ü–†–û–ë–ï–õ</strong> –∏–ª–∏ <strong>–ö–õ–ò–ö–ù–ò–¢–ï</strong> —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –æ—á–∫–∏</p>
        </div>
    </div>

    <!-- Firebase SDK (compat –≤–µ—Ä—Å–∏—è) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- –ù–∞—à–∏ —Å–∫—Ä–∏–ø—Ç—ã –í –ü–†–ê–í–ò–õ–¨–ù–û–ú –ü–û–†–Ø–î–ö–ï -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/database.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin-check.js"></script>
    <script src="../js/game.js"></script>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ -->
    <script>
        // ========================================
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞
        // ========================================
        async function handleLogout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏? –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω.')) {
                try {
                    console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞...');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä—É –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
                    if (window.game && typeof window.game.saveGameData === 'function') {
                        await window.game.saveGameData();
                    }
                    
                    console.log('üëã –í—ã—Ö–æ–¥...');
                    await authSystem.logout();
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ');
                }
            }
        }

        // ========================================
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞
        // ========================================
        auth.onAuthStateChanged(async (user) => {
            if (user && authSystem.getCurrentUser()) {
                const currentUser = authSystem.getCurrentUser();
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
                if (adminSystem && adminSystem.isAdmin(currentUser)) {
                    adminSystem.showAdminButton();
                    console.log('üîë –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã');
                }
            }
        });

        // ========================================
        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        // ========================================
        window.addEventListener('beforeunload', (e) => {
            if (window.game && typeof window.game.saveGameData === 'function') {
                window.game.saveGameData();
            }
        });

        // ========================================
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        // ========================================
        window.addEventListener('error', (e) => {
            console.error('üí• –û—à–∏–±–∫–∞:', e.error);
        });

        // ========================================
        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        // ========================================
        document.addEventListener('keydown', (e) => {
            // ESC - –º–µ–Ω—é
            if (e.key === 'Escape') {
                console.log('‚è∏Ô∏è ESC –Ω–∞–∂–∞—Ç');
            }
            
            // R - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
            if (e.key === 'r' || e.key === 'R') {
                if (window.game && typeof window.game.restart === 'function') {
                    if (confirm('–ù–∞—á–∞—Ç—å –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ?')) {
                        window.game.restart();
                    }
                }
            }
        });

        console.log('‚úÖ game.html –∑–∞–≥—Ä—É–∂–µ–Ω');
        console.log('‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: –ü–†–û–ë–ï–õ - –æ—á–∫–∏, R - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫, ESC - –º–µ–Ω—é');
    </script>
</body>
</html>