<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="RuBlocks - –†—É—Å—Å–∫–∏–π Roblox —Å —Ä–µ–∞–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π">
    <meta name="author" content="tolikpro128">
    <title>RuBlocks - –ò–≥—Ä–∞</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–≥—Ä–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</div>
    </div>

    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã -->
    <div class="game-container" style="display: none;" id="game-main">
        <!-- –®–∞–ø–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∏–≥—Ä–æ–∫–µ -->
        <div class="game-header">
            <div class="user-info">
                <img id="user-avatar" class="user-avatar" src="" alt="Avatar" loading="lazy">
                <span>üë§ <strong id="username">–ó–∞–≥—Ä—É–∑–∫–∞...</strong></span>
                <span>‚≠ê –£—Ä. <strong id="level">1</strong></span>
                <span>üèÜ –†–µ–∫–æ—Ä–¥: <strong id="high-score">0</strong></span>
                <span>üí∞ –ú–æ–Ω–µ—Ç—ã: <strong id="coins">0</strong></span>
                <span>üìä –°—á—ë—Ç: <strong id="current-score">0</strong></span>
            </div>
            <div class="flex gap-10">
                <button class="btn-logout" onclick="handleLogout()">–í—ã—Ö–æ–¥</button>
            </div>
        </div>

        <!-- –ò–≥—Ä–æ–≤–æ–π —Ö–æ–ª—Å—Ç -->
        <canvas id="game-canvas"></canvas>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
        <div id="game-info">
            <p>üéÆ –ù–∞–∂–º–∏—Ç–µ <strong>–ü–†–û–ë–ï–õ</strong> —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –æ—á–∫–∏ (–¥–µ–º–æ-—Ä–µ–∂–∏–º)</p>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–ø—Ä–∏–º–µ—Ä) -->
    <div class="modal" id="pause-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚è∏Ô∏è –ü–∞—É–∑–∞</h2>
                <button class="modal-close" onclick="closePauseModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p>–ò–≥—Ä–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</p>
                <div class="card">
                    <div class="card-header">–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</div>
                    <div class="card-body">
                        <p>–¢–µ–∫—É—â–∏–π —Å—á—ë—Ç: <strong id="modal-score">0</strong></p>
                        <p>–í—Ä–µ–º—è –∏–≥—Ä—ã: <strong id="modal-time">0:00</strong></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePauseModal()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button class="btn-primary" onclick="restartGame()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (compat –≤–µ—Ä—Å–∏—è) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- –ù–∞—à–∏ —Å–∫—Ä–∏–ø—Ç—ã -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/database.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin-check.js"></script>
    <script src="../js/game.js"></script>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ -->
    <script>
        // ========================================
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞ –∏ –ø–æ–∫–∞–∑ –∫–Ω–æ–ø–∫–∏
        // ========================================
        auth.onAuthStateChanged(async (user) => {
            if (user && authSystem.getCurrentUser()) {
                const currentUser = authSystem.getCurrentUser();
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
                if (adminSystem.isAdmin(currentUser)) {
                    adminSystem.showAdminButton();
                    console.log('üîë –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã');
                }
            }
        });

        // ========================================
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞
        // ========================================
        async function handleLogout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏? –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω.')) {
                try {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä—É –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
                    if (window.game && typeof window.game.saveGameData === 'function') {
                        await window.game.saveGameData();
                    }
                    
                    // –í—ã—Ö–æ–¥–∏–º
                    await authSystem.logout();
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ');
                }
            }
        }

        // ========================================
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–∞—É–∑—ã
        // ========================================
        function showPauseModal() {
            const modal = document.getElementById('pause-modal');
            modal.classList.add('show');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –º–æ–¥–∞–ª–∫–µ
            if (window.game) {
                document.getElementById('modal-score').textContent = window.game.score || 0;
                
                const playTime = Math.floor((Date.now() - window.game.startTime) / 1000);
                const minutes = Math.floor(playTime / 60);
                const seconds = playTime % 60;
                document.getElementById('modal-time').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function closePauseModal() {
            const modal = document.getElementById('pause-modal');
            modal.classList.remove('show');
        }

        function restartGame() {
            closePauseModal();
            if (window.game && typeof window.game.restart === 'function') {
                window.game.restart();
            }
        }

        // ========================================
        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        // ========================================
        document.addEventListener('keydown', (e) => {
            // ESC - –ø–∞—É–∑–∞/–º–µ–Ω—é
            if (e.key === 'Escape') {
                showPauseModal();
            }
            
            // F11 - –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
        });

        // ========================================
        // –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        // ========================================
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // ========================================
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        // ========================================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <strong>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</strong>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ========================================
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Ö–æ–¥–∞ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        // ========================================
        window.addEventListener('beforeunload', (e) => {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            if (window.game && typeof window.game.saveGameData === 'function') {
                window.game.saveGameData();
            }
        });

        // ========================================
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞
        // ========================================
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('‚è∏Ô∏è –ò–≥—Ä–∞ —Å–≤—ë—Ä–Ω—É—Ç–∞, –∞–≤—Ç–æ–ø–∞—É–∑–∞');
                // –ú–æ–∂–Ω–æ –∑–¥–µ—Å—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∏–≥—Ä—É –Ω–∞ –ø–∞—É–∑—É
            } else {
                console.log('‚ñ∂Ô∏è –ò–≥—Ä–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            }
        });

        // ========================================
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        // ========================================
        function checkPerformance() {
            if (performance && performance.memory) {
                const used = performance.memory.usedJSHeapSize / 1048576;
                const total = performance.memory.totalJSHeapSize / 1048576;
                
                console.log(`üíæ –ü–∞–º—è—Ç—å: ${used.toFixed(2)} MB / ${total.toFixed(2)} MB`);
                
                // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –ø–∞–º—è—Ç–∏ –º–∞–ª–æ
                if (used / total > 0.9) {
                    console.warn('‚ö†Ô∏è –ú–∞–ª–æ –ø–∞–º—è—Ç–∏! –í–æ–∑–º–æ–∂–Ω—ã –ª–∞–≥–∏.');
                }
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(checkPerformance, 30000);

        // ========================================
        // Debug –ø–∞–Ω–µ–ª—å (—Ç–æ–ª—å–∫–æ –≤ development)
        // ========================================
        if (window.location.hostname === 'localhost' || 
            window.location.hostname === '127.0.0.1') {
            
            console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë        üéÆ RuBlocks Debug Mode         ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë                                        ‚ïë
‚ïë  –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:                      ‚ïë
‚ïë  ESC    - –ü–∞—É–∑–∞                        ‚ïë
‚ïë  F11    - –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω                 ‚ïë
‚ïë  SPACE  - –î–æ–±–∞–≤–∏—Ç—å –æ—á–∫–∏ (–¥–µ–º–æ)         ‚ïë
‚ïë                                        ‚ïë
‚ïë  –§—É–Ω–∫—Ü–∏–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏:                    ‚ïë
‚ïë  showNotification(msg, type)           ‚ïë
‚ïë  checkPerformance()                    ‚ïë
‚ïë  toggleFullscreen()                    ‚ïë
‚ïë                                        ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            `);
        }

        // ========================================
        // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        // ========================================
        window.addEventListener('load', () => {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                const gameMain = document.getElementById('game-main');
                
                if (loadingScreen) {
                    loadingScreen.style.animation = 'fadeOut 0.5s';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        if (gameMain) {
                            gameMain.style.display = 'flex';
                        }
                    }, 500);
                }
            }, 1000);
        });

        // ========================================
        // PWA Support (Progressive Web App)
        // ========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å Service Worker
                // –¥–ª—è –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                console.log('üåê PWA –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');
            });
        }

        // ========================================
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        // ========================================
        window.addEventListener('error', (e) => {
            console.error('üí• –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', e.error);
            
            // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            if (window.location.hostname !== 'localhost') {
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—à–∏–±–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
            }
        });

        // ========================================
        // FPS Counter (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        // ========================================
        let lastTime = performance.now();
        let fps = 0;
        
        function updateFPS() {
            const now = performance.now();
            fps = Math.round(1000 / (now - lastTime));
            lastTime = now;
            
            // –ú–æ–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å FPS –≤ debug —Ä–µ–∂–∏–º–µ
            // console.log('FPS:', fps);
            
            requestAnimationFrame(updateFPS);
        }
        
        if (window.location.hostname === 'localhost') {
            updateFPS();
        }

        console.log('‚úÖ game.html –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
    </script>
</body>
</html>