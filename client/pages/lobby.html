<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>RuBlocks - –õ–æ–±–±–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.2);
            border-top: 5px solid #00b06f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            margin-top: 20px;
            font-size: 20px;
            color: #00b06f;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            background: rgba(0, 0, 0, 0.6);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #00b06f;
        }

        .header-nav {
            display: flex;
            gap: 5px;
        }

        .nav-tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 8px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover { background: rgba(255,255,255,0.1); }
        .nav-tab.active { background: #00b06f; color: white; }

        .user-panel {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Rubox */
        .rubox-balance {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #00b06f 0%, #008f5a 100%);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .rubox-balance:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 176, 111, 0.5);
        }

        .rubox-icon {
            width: 24px;
            height: 24px;
            background: #ffd700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .rubox-amount {
            font-weight: bold;
            font-size: 16px;
        }

        .rubox-plus {
            background: rgba(255,255,255,0.2);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #00b06f;
            cursor: pointer;
        }

        .btn-logout {
            padding: 8px 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { display: none; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Connections */
        .connections-section {
            padding: 15px 20px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .connections-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
        }

        .connections-title {
            font-size: 16px;
            font-weight: bold;
            color: #00b06f;
        }

        .connections-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-add-connection {
            flex-shrink: 0;
            width: 60px;
            height: 80px;
            background: rgba(0, 176, 111, 0.2);
            border: 2px dashed #00b06f;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add-connection:hover {
            background: rgba(0, 176, 111, 0.3);
            transform: scale(1.05);
        }

        .btn-add-connection .add-icon { font-size: 22px; }
        .btn-add-connection .add-text { font-size: 8px; font-weight: 600; color: #00b06f; }

        .connections-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 0;
            -webkit-overflow-scrolling: touch;
        }

        .connections-scroll::-webkit-scrollbar { height: 4px; }
        .connections-scroll::-webkit-scrollbar-thumb { background: #00b06f; border-radius: 10px; }

        .connection-card {
            flex-shrink: 0;
            width: 60px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .connection-card:hover { transform: translateY(-3px); }

        .connection-avatar-container {
            position: relative;
            width: 50px;
            height: 50px;
            margin: 0 auto 5px;
        }

        .connection-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #00b06f;
        }

        .connection-status-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #1a1a2e;
        }

        .connection-status-dot.online { background: #4ade80; }
        .connection-status-dot.offline { background: #6b7280; }

        .connection-name {
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .connections-empty {
            color: rgba(255,255,255,0.4);
            font-size: 12px;
        }

        /* –ò–≥—Ä—ã */
        .games-section {
            padding: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 22px;
            font-weight: bold;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .game-card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .game-card:hover {
            transform: translateY(-5px);
            border-color: #00b06f;
            box-shadow: 0 10px 30px rgba(0, 176, 111, 0.3);
        }

        .game-image {
            width: 100%;
            height: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            position: relative;
        }

        .game-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #00b06f;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .game-badge.hot { background: #e74c3c; }
        .game-badge.new { background: #3498db; }

        .game-info {
            padding: 15px;
        }

        .game-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 10px;
        }

        .game-players { color: #4ade80; }

        .btn-play {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #00b06f 0%, #008f5a 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-play:hover {
            transform: scale(1.02);
        }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .profile-sidebar {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100%;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(10px);
            z-index: 200;
            transition: all 0.3s;
            padding: 20px;
            overflow-y: auto;
        }

        .profile-sidebar.open { right: 0; }

        .profile-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid #00b06f;
            margin: 30px auto 15px;
            display: block;
        }

        .profile-name {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-username {
            text-align: center;
            font-size: 14px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 20px;
        }

        .profile-rubox {
            background: linear-gradient(135deg, #00b06f 0%, #008f5a 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-rubox-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .profile-rubox-amount {
            font-size: 32px;
            font-weight: bold;
        }

        .btn-buy-rubox {
            width: 100%;
            padding: 12px;
            background: #ffd700;
            border: none;
            border-radius: 10px;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .profile-stat {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .profile-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00b06f;
        }

        .profile-stat-label {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
        }

        /* –ß–∞—Ç—ã */
        .chats-screen {
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
        }

        .chats-header {
            padding: 15px 20px;
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chats-title { font-size: 20px; font-weight: bold; }

        .chats-actions { display: flex; gap: 10px; }

        .btn-new-chat, .btn-new-group {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-new-chat { background: #00b06f; color: white; }
        .btn-new-group { background: #3498db; color: white; }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #00b06f;
        }

        .chat-avatar.group {
            background: linear-gradient(135deg, #00b06f, #008f5a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: none;
        }

        .chat-info { flex: 1; }
        .chat-name { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .chat-last-msg { font-size: 12px; color: rgba(255,255,255,0.5); }

        .chats-empty {
            text-align: center;
            padding: 50px;
            color: rgba(255,255,255,0.5);
        }

        .chats-empty-icon { font-size: 50px; margin-bottom: 15px; }

        /* –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç */
        .chat-screen {
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px 20px;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-back {
            padding: 8px 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .chat-header-info { flex: 1; }
        .chat-header-name { font-weight: bold; }
        .chat-header-status { font-size: 12px; color: #4ade80; }

        .btn-party {
            padding: 10px 18px;
            background: linear-gradient(135deg, #f093fb, #f5576c);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .message.own { flex-direction: row-reverse; }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }

        .message.own .message-bubble { background: #00b06f; }

        .message-text { font-size: 14px; }
        .message-time { font-size: 10px; color: rgba(255,255,255,0.4); margin-top: 5px; }

        .chat-input-section {
            padding: 15px;
            background: rgba(0,0,0,0.4);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 18px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 14px;
        }

        .chat-input::placeholder { color: rgba(255,255,255,0.5); }
        .chat-input:focus { outline: none; }

        .btn-send {
            width: 45px;
            height: 45px;
            background: #00b06f;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 18px;
        }

        /* Party */
        .party-screen {
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
        }

        .party-header {
            padding: 20px;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .party-title {
            font-size: 22px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .party-title-icon { animation: bounce 1s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .btn-leave-party {
            padding: 10px 20px;
            background: #e74c3c;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: 600;
        }

        .party-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .party-members {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .party-member { text-align: center; width: 100px; }

        .party-member-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin: 0 auto 10px;
            border: 4px solid #00b06f;
        }

        .party-member-avatar.speaking {
            border-color: #4ade80;
            animation: speakPulse 0.5s infinite;
        }

        @keyframes speakPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
        }

        .party-member-name { font-weight: bold; font-size: 13px; }
        .party-member-mic { font-size: 18px; margin-top: 5px; }

        .voice-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: auto;
            padding: 20px;
        }

        .voice-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 26px;
            transition: all 0.3s;
        }

        .voice-btn.mic { background: #4ade80; color: white; }
        .voice-btn.mic.muted { background: #e74c3c; }
        .voice-btn.deafen { background: rgba(255,255,255,0.1); color: white; }
        .voice-btn.deafen.active { background: #e74c3c; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: #1a1a2e;
            padding: 25px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title { font-size: 18px; font-weight: bold; color: #00b06f; }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px; }
        .input-group input {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            color: white;
            font-size: 14px;
        }
        .input-group input:focus { outline: none; border-color: #00b06f; }

        .select-list { max-height: 250px; overflow-y: auto; }

        .select-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .select-item:hover { background: rgba(255,255,255,0.1); }
        .select-item.selected { background: rgba(0, 176, 111, 0.3); border: 2px solid #00b06f; }

        .select-avatar { width: 40px; height: 40px; border-radius: 50%; }
        .select-name { flex: 1; font-weight: 600; }
        .select-check { font-size: 20px; color: #4ade80; display: none; }
        .select-item.selected .select-check { display: block; }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: #00b06f;
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px 20px;
            z-index: 1000;
            animation: slideIn 0.3s;
            max-width: 300px;
        }

        .notification.success { border-left: 4px solid #4ade80; }
        .notification.error { border-left: 4px solid #e74c3c; }
        .notification.info { border-left: 4px solid #00b06f; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤ */
        @media (max-width: 768px) {
            .header { flex-wrap: wrap; gap: 10px; }
            .header-nav { order: 3; width: 100%; justify-content: center; }
            .games-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .profile-sidebar { width: 100%; right: -100%; }
        }

        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: #00b06f; border-radius: 10px; }
    </style>
</head>
<body>
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ RuBlocks...</div>
    </div>

    <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="app" style="display: none;">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="header">
            <div class="logo">üéÆ RuBlocks</div>

            <div class="header-nav">
                <button class="nav-tab active" onclick="showScreen('lobby')">üè† –ì–ª–∞–≤–Ω–∞—è</button>
                <button class="nav-tab" onclick="showScreen('chats')">üí¨ –ß–∞—Ç—ã</button>
            </div>

            <div class="user-panel">
                <div class="rubox-balance" onclick="openRuboxShop()">
                    <div class="rubox-icon">R</div>
                    <span class="rubox-amount" id="rubox-amount">0</span>
                    <div class="rubox-plus">+</div>
                </div>
                <img id="header-avatar" class="user-avatar" src="" alt="" onclick="toggleProfile()">
                <button class="btn-logout" onclick="handleLogout()">–í—ã—Ö–æ–¥</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ª–æ–±–±–∏ -->
        <div class="screen active" id="screen-lobby">
            <!-- Connections -->
            <div class="connections-section">
                <div class="connections-header">
                    <span class="connections-title">ü§ù Connections</span>
                </div>
                <div class="connections-row">
                    <div class="btn-add-connection" onclick="openAddConnection()">
                        <span class="add-icon">‚ûï</span>
                        <span class="add-text">–î–æ–±–∞–≤–∏—Ç—å</span>
                    </div>
                    <div class="connections-scroll" id="connections-scroll">
                        <span class="connections-empty" id="connections-empty">–î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–∑–µ–π ‚Üí</span>
                    </div>
                </div>
            </div>

            <!-- –ò–≥—Ä—ã -->
            <div class="games-section">
                <div class="section-header">
                    <span class="section-title">üéÆ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–≥—Ä—ã</span>
                </div>

                <div class="games-grid">
                    <!-- –ü–∏—Ü—Ü–µ—Ä–∏—è -->
                    <div class="game-card" onclick="playGame('pizzeria')">
                        <div class="game-image" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                            üçï
                            <span class="game-badge hot">HOT</span>
                        </div>
                        <div class="game-info">
                            <div class="game-title">–†–∞–±–æ—Ç–∞ –≤ –ø–∏—Ü—Ü–µ—Ä–∏–∏</div>
                            <div class="game-stats">
                                <span class="game-players">üü¢ 12,456 –∏–≥—Ä–∞—é—Ç</span>
                                <span>‚≠ê 4.9</span>
                            </div>
                            <button class="btn-play">‚ñ∂ –ò–≥—Ä–∞—Ç—å</button>
                        </div>
                    </div>

                    <!-- –°–∏–º—É–ª—è—Ç–æ—Ä -->
                    <div class="game-card" onclick="playGame('simulator')">
                        <div class="game-image" style="background: linear-gradient(135deg, #a29bfe, #6c5ce7);">
                            üí™
                            <span class="game-badge new">NEW</span>
                        </div>
                        <div class="game-info">
                            <div class="game-title">–°–∏–º—É–ª—è—Ç–æ—Ä —Å–∏–ª—ã</div>
                            <div class="game-stats">
                                <span class="game-players">üü¢ 8,234 –∏–≥—Ä–∞—é—Ç</span>
                                <span>‚≠ê 4.7</span>
                            </div>
                            <button class="btn-play">‚ñ∂ –ò–≥—Ä–∞—Ç—å</button>
                        </div>
                    </div>

                    <!-- Adopt Me -->
                    <div class="game-card" onclick="playGame('adopt')">
                        <div class="game-image" style="background: linear-gradient(135deg, #fdcb6e, #e17055);">
                            üêæ
                        </div>
                        <div class="game-info">
                            <div class="game-title">–ü—Ä–∏—é—Ç–∏ –ø–∏—Ç–æ–º—Ü–∞</div>
                            <div class="game-stats">
                                <span class="game-players">üü¢ 15,789 –∏–≥—Ä–∞—é—Ç</span>
                                <span>‚≠ê 4.8</span>
                            </div>
                            <button class="btn-play">‚ñ∂ –ò–≥—Ä–∞—Ç—å</button>
                        </div>
                    </div>

                    <!-- –¢–∞–π–∫—É–Ω -->
                    <div class="game-card" onclick="playGame('tycoon')">
                        <div class="game-image" style="background: linear-gradient(135deg, #00b894, #00cec9);">
                            üè≠
                        </div>
                        <div class="game-info">
                            <div class="game-title">–¢–∞–π–∫—É–Ω –∑–∞–≤–æ–¥</div>
                            <div class="game-stats">
                                <span class="game-players">üü¢ 5,432 –∏–≥—Ä–∞—é—Ç</span>
                                <span>‚≠ê 4.5</span>
                            </div>
                            <button class="btn-play">‚ñ∂ –ò–≥—Ä–∞—Ç—å</button>
                        </div>
                    </div>

                    <!-- –û–±–±–∏ -->
                    <div class="game-card" onclick="playGame('obby')">
                        <div class="game-image" style="background: linear-gradient(135deg, #74b9ff, #0984e3);">
                            üèÉ
                        </div>
                        <div class="game-info">
                            <div class="game-title">–ú–µ–≥–∞ –û–±–±–∏</div>
                            <div class="game-stats">
                                <span class="game-players">üü¢ 9,123 –∏–≥—Ä–∞—é—Ç</span>
                                <span>‚≠ê 4.6</span>
                            </div>
                            <button class="btn-play">‚ñ∂ –ò–≥—Ä–∞—Ç—å</button>
                        </div>
                    </div>

                    <!-- –•–æ—Ä—Ä–æ—Ä -->
                    <div class="game-card" onclick="playGame('horror')">
                        <div class="game-image" style="background: linear-gradient(135deg, #2d3436, #636e72);">
                            üëª
                        </div>
                        <div class="game-info">
                            <div class="game-title">–ü–æ–±–µ–≥ –æ—Ç –º–æ–Ω—Å—Ç—Ä–∞</div>
                            <div class="game-stats">
                                <span class="game-players">üü¢ 3,456 –∏–≥—Ä–∞—é—Ç</span>
                                <span>‚≠ê 4.4</span>
                            </div>
                            <button class="btn-play">‚ñ∂ –ò–≥—Ä–∞—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–æ–≤ -->
        <div class="screen" id="screen-chats">
            <div class="chats-screen">
                <div class="chats-header">
                    <span class="chats-title">üí¨ –ß–∞—Ç—ã</span>
                    <div class="chats-actions">
                        <button class="btn-new-chat" onclick="openNewChat()">‚ûï –ß–∞—Ç</button>
                        <button class="btn-new-group" onclick="openNewGroup()">üë• –ì—Ä—É–ø–ø–∞</button>
                    </div>
                </div>
                <div class="chats-list" id="chats-list">
                    <div class="chats-empty" id="chats-empty">
                        <div class="chats-empty-icon">üí¨</div>
                        <h3>–ù–µ—Ç —á–∞—Ç–æ–≤</h3>
                        <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –¥—Ä—É–∑—å—è–º–∏!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
        <div class="screen" id="screen-chat">
            <div class="chat-screen">
                <div class="chat-header">
                    <button class="btn-back" onclick="showScreen('chats')">‚Üê</button>
                    <img class="chat-header-avatar" id="chat-avatar" src="">
                    <div class="chat-header-info">
                        <div class="chat-header-name" id="chat-name">–ß–∞—Ç</div>
                        <div class="chat-header-status" id="chat-status">–û–Ω–ª–∞–π–Ω</div>
                    </div>
                    <button class="btn-party" onclick="startParty()">üéâ Party</button>
                </div>
                <div class="chat-messages" id="chat-messages"></div>
                <div class="chat-input-section">
                    <input class="chat-input" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                    <button class="btn-send" onclick="sendChatMessage()">‚û§</button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω Party -->
        <div class="screen" id="screen-party">
            <div class="party-screen">
                <div class="party-header">
                    <div class="party-title">
                        <span class="party-title-icon">üéâ</span> Party
                    </div>
                    <button class="btn-leave-party" onclick="leaveParty()">–í—ã–π—Ç–∏</button>
                </div>
                <div class="party-content">
                    <div class="party-members" id="party-members"></div>
                    <div class="voice-controls">
                        <button class="voice-btn mic" id="btn-mic" onclick="toggleMic()">üé§</button>
                        <button class="voice-btn deafen" id="btn-deafen" onclick="toggleDeafen()">üîä</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–æ—Ñ–∏–ª—å —Å–∞–π–¥–±–∞—Ä -->
    <div class="profile-sidebar" id="profile-sidebar">
        <button class="profile-close" onclick="toggleProfile()">√ó</button>
        <img class="profile-avatar-large" id="profile-avatar" src="">
        <div class="profile-name" id="profile-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="profile-username" id="profile-username">@username</div>

        <div class="profile-rubox">
            <div class="profile-rubox-label">–ë–∞–ª–∞–Ω—Å Rubox</div>
            <div class="profile-rubox-amount" id="profile-rubox">0</div>
            <button class="btn-buy-rubox" onclick="openRuboxShop()">üí≥ –ö—É–ø–∏—Ç—å Rubox</button>
        </div>

        <div class="profile-stats">
            <div class="profile-stat">
                <div class="profile-stat-value" id="stat-connections">0</div>
                <div class="profile-stat-label">–î—Ä—É–∑–µ–π</div>
            </div>
            <div class="profile-stat">
                <div class="profile-stat-value" id="stat-games">0</div>
                <div class="profile-stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <!-- Add Connection -->
    <div class="modal" id="modal-add-connection">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</span>
                <button class="modal-close" onclick="closeModal('modal-add-connection')">√ó</button>
            </div>
            <div class="input-group">
                <label>üîç –ü–æ–∏—Å–∫</label>
                <input type="text" id="search-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è..." oninput="searchUsers()">
            </div>
            <div class="select-list" id="search-results"></div>
        </div>
    </div>

    <!-- New Chat -->
    <div class="modal" id="modal-new-chat">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">üí¨ –ù–æ–≤—ã–π —á–∞—Ç</span>
                <button class="modal-close" onclick="closeModal('modal-new-chat')">√ó</button>
            </div>
            <div class="select-list" id="new-chat-list"></div>
        </div>
    </div>

    <!-- New Group -->
    <div class="modal" id="modal-new-group">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">üë• –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</span>
                <button class="modal-close" onclick="closeModal('modal-new-group')">√ó</button>
            </div>
            <div class="input-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
                <input type="text" id="group-name" placeholder="–ú–æ—è –≥—Ä—É–ø–ø–∞">
            </div>
            <p style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:10px;">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</p>
            <div class="select-list" id="group-list"></div>
            <button class="btn-primary" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <!-- Rubox Shop -->
    <div class="modal" id="modal-rubox">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">üí∞ –ú–∞–≥–∞–∑–∏–Ω Rubox</span>
                <button class="modal-close" onclick="closeModal('modal-rubox')">√ó</button>
            </div>
            <div style="text-align:center;padding:30px;">
                <div style="font-size:60px;margin-bottom:15px;">üíé</div>
                <h3>Rubox —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω!</h3>
                <p style="color:rgba(255,255,255,0.5);margin-top:10px;">
                    –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ Rubox –∏–≥—Ä–∞—è –≤ –∏–≥—Ä—ã
                </p>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA76Du2jnVguJavcO7k6XFEQJ0tPhHF_UI",
            authDomain: "rublocks-2862b.firebaseapp.com",
            projectId: "rublocks-2862b",
            storageBucket: "rublocks-2862b.firebasestorage.app",
            messagingSenderId: "1035853997972",
            appId: "1:1035853997972:web:77cf13e7197b9387cd9181"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userProfile = null;
        let connections = [];
        let chats = [];
        let currentChatId = null;
        let currentChatData = null;
        let selectedGroupMembers = [];
        let isMicMuted = false;
        let isDeafened = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile();
                initApp();
            } else {
                window.location.href = '../index.html';
            }
        });

        async function loadUserProfile() {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                userProfile = doc.data();
            } else {
                userProfile = {
                    username: currentUser.displayName || currentUser.email.split('@')[0],
                    email: currentUser.email,
                    rubox: 100,
                    gamesPlayed: 0,
                    connections: []
                };
                await db.collection('users').doc(currentUser.uid).set(userProfile);
            }
        }

        function initApp() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            updateUI();
            loadConnections();
            loadChats();
            setOnlineStatus(true);
        }

        function updateUI() {
            const avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.uid}`;
            document.getElementById('header-avatar').src = avatar;
            document.getElementById('profile-avatar').src = avatar;
            document.getElementById('rubox-amount').textContent = userProfile?.rubox || 0;
            document.getElementById('profile-rubox').textContent = userProfile?.rubox || 0;
            document.getElementById('profile-name').textContent = userProfile?.username || '–ò–≥—Ä–æ–∫';
            document.getElementById('profile-username').textContent = '@' + (userProfile?.username || 'user');
            document.getElementById('stat-connections').textContent = (userProfile?.connections || []).length;
            document.getElementById('stat-games').textContent = userProfile?.gamesPlayed || 0;
        }

        function showScreen(name) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('screen-' + name).classList.add('active');
            if (name === 'lobby') document.querySelector('.nav-tab:nth-child(1)').classList.add('active');
            if (name === 'chats') document.querySelector('.nav-tab:nth-child(2)').classList.add('active');
        }

        function toggleProfile() {
            document.getElementById('profile-sidebar').classList.toggle('open');
        }

        // –ò–≥—Ä—ã
        function playGame(gameId) {
            if (gameId === 'pizzeria') {
                window.location.href = 'games/pizzeria.html';
            } else {
                showNotification('üéÆ –ò–≥—Ä–∞ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞!', 'info');
            }
        }

        function openRuboxShop() {
            document.getElementById('modal-rubox').classList.add('show');
        }

        // Connections
        async function loadConnections() {
            const ids = userProfile?.connections || [];
            connections = [];
            if (ids.length > 0) {
                for (const id of ids) {
                    const doc = await db.collection('users').doc(id).get();
                    if (doc.exists) connections.push({ id: doc.id, ...doc.data() });
                }
            }
            renderConnections();
        }

        function renderConnections() {
            const scroll = document.getElementById('connections-scroll');
            const empty = document.getElementById('connections-empty');
            
            if (connections.length === 0) {
                scroll.innerHTML = '';
                empty.style.display = 'block';
                scroll.appendChild(empty);
                return;
            }

            empty.style.display = 'none';
            scroll.innerHTML = connections.map(c => `
                <div class="connection-card" onclick="startChatWith('${c.id}')">
                    <div class="connection-avatar-container">
                        <img class="connection-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=${c.id}">
                        <div class="connection-status-dot ${c.isOnline ? 'online' : 'offline'}"></div>
                    </div>
                    <div class="connection-name">${escapeHtml(c.username || '–ò–≥—Ä–æ–∫')}</div>
                </div>
            `).join('');
        }

        function openAddConnection() {
            document.getElementById('modal-add-connection').classList.add('show');
            document.getElementById('search-username').value = '';
            document.getElementById('search-results').innerHTML = '';
        }

        let searchTimeout;
        async function searchUsers() {
            const q = document.getElementById('search-username').value.trim().toLowerCase();
            const results = document.getElementById('search-results');
            if (q.length < 2) { results.innerHTML = ''; return; }

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const snapshot = await db.collection('users').limit(20).get();
                let found = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (doc.id !== currentUser.uid && (data.username || '').toLowerCase().includes(q) && !(userProfile?.connections || []).includes(doc.id)) {
                        found.push({ id: doc.id, ...data });
                    }
                });

                results.innerHTML = found.length ? found.map(u => `
                    <div class="select-item" onclick="sendRequest('${u.id}', '${escapeHtml(u.username)}')">
                        <img class="select-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=${u.id}">
                        <span class="select-name">${escapeHtml(u.username || '–ò–≥—Ä–æ–∫')}</span>
                    </div>
                `).join('') : '<p style="text-align:center;color:rgba(255,255,255,0.5);">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
            }, 500);
        }

        async function sendRequest(id, name) {
            await db.collection('users').doc(id).update({
                connectionRequests: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
            });
            showNotification('‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ' + name, 'success');
            closeModal('modal-add-connection');
        }

        // –ß–∞—Ç—ã
        async function loadChats() {
            db.collection('chats').where('members', 'array-contains', currentUser.uid)
                .orderBy('lastMessageTime', 'desc').onSnapshot(snapshot => {
                    chats = [];
                    snapshot.forEach(doc => chats.push({ id: doc.id, ...doc.data() }));
                    renderChats();
                });
        }

        async function renderChats() {
            const list = document.getElementById('chats-list');
            const empty = document.getElementById('chats-empty');
            
            if (chats.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                list.appendChild(empty);
                return;
            }

            empty.style.display = 'none';
            let html = '';

            for (const chat of chats) {
                let avatar, name;
                if (chat.isGroup) {
                    avatar = '<div class="chat-avatar group">üë•</div>';
                    name = chat.name || '–ì—Ä—É–ø–ø–∞';
                } else {
                    const otherId = chat.members.find(m => m !== currentUser.uid);
                    const doc = await db.collection('users').doc(otherId).get();
                    const other = doc.data() || {};
                    avatar = `<img class="chat-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=${otherId}">`;
                    name = other.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                }

                html += `
                    <div class="chat-item" onclick="openChat('${chat.id}')">
                        ${avatar}
                        <div class="chat-info">
                            <div class="chat-name">${escapeHtml(name)}</div>
                            <div class="chat-last-msg">${escapeHtml(chat.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π')}</div>
                        </div>
                    </div>
                `;
            }
            list.innerHTML = html;
        }

        function openNewChat() {
            const list = document.getElementById('new-chat-list');
            list.innerHTML = connections.length ? connections.map(c => `
                <div class="select-item" onclick="startChatWith('${c.id}')">
                    <img class="select-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=${c.id}">
                    <span class="select-name">${escapeHtml(c.username || '–ò–≥—Ä–æ–∫')}</span>
                </div>
            `).join('') : '<p style="text-align:center;color:rgba(255,255,255,0.5);">–î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–∑–µ–π</p>';
            document.getElementById('modal-new-chat').classList.add('show');
        }

        async function startChatWith(userId) {
            closeModal('modal-new-chat');
            const existing = chats.find(c => !c.isGroup && c.members.includes(userId) && c.members.includes(currentUser.uid));
            if (existing) { openChat(existing.id); return; }

            const ref = await db.collection('chats').add({
                members: [currentUser.uid, userId],
                isGroup: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastMessage: '',
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
            });
            openChat(ref.id);
        }

        function openNewGroup() {
            selectedGroupMembers = [];
            document.getElementById('group-name').value = '';
            const list = document.getElementById('group-list');
            list.innerHTML = connections.map(c => `
                <div class="select-item" id="grp-${c.id}" onclick="toggleGroupMember('${c.id}')">
                    <img class="select-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=${c.id}">
                    <span class="select-name">${escapeHtml(c.username || '–ò–≥—Ä–æ–∫')}</span>
                    <span class="select-check">‚úì</span>
                </div>
            `).join('');
            document.getElementById('modal-new-group').classList.add('show');
        }

        function toggleGroupMember(id) {
            const el = document.getElementById('grp-' + id);
            if (selectedGroupMembers.includes(id)) {
                selectedGroupMembers = selectedGroupMembers.filter(m => m !== id);
                el.classList.remove('selected');
            } else {
                selectedGroupMembers.push(id);
                el.classList.add('selected');
            }
        }

        async function createGroup() {
            const name = document.getElementById('group-name').value.trim() || '–ì—Ä—É–ø–ø–∞';
            if (selectedGroupMembers.length === 0) { showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤', 'error'); return; }

            const ref = await db.collection('chats').add({
                members: [currentUser.uid, ...selectedGroupMembers],
                isGroup: true,
                name: name,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastMessage: '–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞',
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
            });

            closeModal('modal-new-group');
            showNotification('‚úÖ –ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
            openChat(ref.id);
        }

        async function openChat(chatId) {
            currentChatId = chatId;
            const doc = await db.collection('chats').doc(chatId).get();
            currentChatData = { id: doc.id, ...doc.data() };

            const avatar = document.getElementById('chat-avatar');
            const name = document.getElementById('chat-name');
            const status = document.getElementById('chat-status');

            if (currentChatData.isGroup) {
                avatar.src = '';
                avatar.style.background = 'linear-gradient(135deg, #00b06f, #008f5a)';
                avatar.innerHTML = 'üë•';
                name.textContent = currentChatData.name || '–ì—Ä—É–ø–ø–∞';
                status.textContent = currentChatData.members.length + ' —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤';
            } else {
                const otherId = currentChatData.members.find(m => m !== currentUser.uid);
                const otherDoc = await db.collection('users').doc(otherId).get();
                const other = otherDoc.data() || {};
                avatar.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${otherId}`;
                avatar.style.background = '';
                name.textContent = other.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                status.textContent = other.isOnline ? 'üü¢ –û–Ω–ª–∞–π–Ω' : '‚ö´ –û—Ñ–ª–∞–π–Ω';
            }

            db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp').onSnapshot(snapshot => {
                const msgs = [];
                snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
                renderMessages(msgs);
            });

            showScreen('chat');
        }

        function renderMessages(messages) {
            const container = document.getElementById('chat-messages');
            container.innerHTML = messages.map(m => {
                const isOwn = m.senderId === currentUser.uid;
                return `
                    <div class="message ${isOwn ? 'own' : ''}">
                        <img class="message-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=${m.senderId}">
                        <div class="message-bubble">
                            <div class="message-text">${escapeHtml(m.text)}</div>
                            <div class="message-time">${formatTime(m.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('') || '<p style="text-align:center;padding:50px;color:rgba(255,255,255,0.4);">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>';
            container.scrollTop = container.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !currentChatId) return;

            await db.collection('chats').doc(currentChatId).collection('messages').add({
                senderId: currentUser.uid,
                senderName: userProfile?.username || '–ò–≥—Ä–æ–∫',
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            await db.collection('chats').doc(currentChatId).update({
                lastMessage: text,
                lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
            });

            input.value = '';
        }

        document.getElementById('message-input').addEventListener('keypress', e => { if (e.key === 'Enter') sendChatMessage(); });

        // Party
        async function startParty() {
            if (!currentChatData) return;
            const members = [];
            members.push({ id: currentUser.uid, name: userProfile?.username || '–Ø', isMuted: false });
            for (const id of currentChatData.members) {
                if (id !== currentUser.uid) {
                    const doc = await db.collection('users').doc(id).get();
                    members.push({ id, name: doc.data()?.username || '–ò–≥—Ä–æ–∫', isMuted: true });
                }
            }
            renderParty(members);
            showScreen('party');
            showNotification('üéâ Party –Ω–∞—á–∞—Ç–∞!', 'success');
        }

        function renderParty(members) {
            document.getElementById('party-members').innerHTML = members.map(m => `
                <div class="party-member">
                    <img class="party-member-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=${m.id}">
                    <div class="party-member-name">${escapeHtml(m.name)}</div>
                    <div class="party-member-mic">${m.isMuted ? 'üîá' : 'üé§'}</div>
                </div>
            `).join('');
        }

        function toggleMic() {
            isMicMuted = !isMicMuted;
            const btn = document.getElementById('btn-mic');
            btn.classList.toggle('muted', isMicMuted);
            btn.textContent = isMicMuted ? 'üîá' : 'üé§';
            showNotification(isMicMuted ? 'üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª' : 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª', 'info');
        }

        function toggleDeafen() {
            isDeafened = !isDeafened;
            const btn = document.getElementById('btn-deafen');
            btn.classList.toggle('active', isDeafened);
            btn.textContent = isDeafened ? 'üîà' : 'üîä';
        }

        function leaveParty() {
            showScreen('chat');
            showNotification('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ Party', 'info');
        }

        // Utils
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function formatTime(ts) { if (!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }); }
        function showNotification(msg, type) { const n = document.createElement('div'); n.className = 'notification ' + type; n.textContent = msg; document.body.appendChild(n); setTimeout(() => n.remove(), 3000); }
        async function setOnlineStatus(s) { await db.collection('users').doc(currentUser.uid).update({ isOnline: s }).catch(() => {}); }
        async function handleLogout() { if (confirm('–í—ã–π—Ç–∏?')) { await setOnlineStatus(false); await auth.signOut(); } }
        window.addEventListener('beforeunload', () => setOnlineStatus(false));
    </script>
</body>
</html>